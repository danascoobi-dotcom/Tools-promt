<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veo 3.1 AI Studio - Full Body Consistency</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: white; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
        .glass-panel {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .active-mode { background-color: #dc2626; color: white; box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.3); }
        .inactive-mode { color: #94a3b8; }
        
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .magic-btn {
            background: linear-gradient(45deg, #4f46e5, #9333ea, #ec4899);
            background-size: 200% 200%;
            animation: gradientMove 3s ease infinite;
        }
        @keyframes gradientMove { 0% { background-position: 0% 50% } 50% { background-position: 100% 50% } 100% { background-position: 0% 50% } }

        .toast-enter { transform: translate(-50%, 20px); opacity: 0; }
        .toast-active { transform: translate(-50%, 0); opacity: 1; }
    </style>
</head>
<body class="min-h-screen flex justify-center items-start pt-2 pb-10 bg-black">

    <div class="w-full max-w-md bg-slate-900 min-h-[95vh] rounded-[2rem] overflow-hidden shadow-2xl border border-slate-800 relative flex flex-col">
        
        <!-- Header -->
        <div class="p-6 pb-4 bg-slate-900 z-10 sticky top-0 border-b border-slate-800">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-xl font-bold bg-gradient-to-r from-blue-400 to-indigo-400 bg-clip-text text-transparent">Veo AI Studio</h1>
                    <p class="text-[10px] text-slate-500 font-medium">Full Body Character Consistency</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleApiSection()" id="apiKeyTriggerBtn" class="px-3 py-1.5 rounded-lg bg-slate-800 text-slate-400 hover:text-white hover:bg-slate-700 text-xs font-bold flex items-center gap-1 transition border border-slate-700 active:scale-95">
                        <i data-lucide="key" class="w-3 h-3"></i> API Key
                    </button>
                </div>
            </div>

            <!-- API Input -->
            <div id="apiSection" class="hidden mb-4 bg-slate-800 p-3 rounded-xl border border-slate-700 shadow-inner">
                <label class="text-xs text-slate-400 mb-1 block">Groq API Key (Wajib untuk Riset)</label>
                <div class="flex gap-2">
                    <input type="password" id="apiKeyInput" placeholder="gsk_..." class="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-white focus:border-blue-500 outline-none transition-colors">
                    <button id="saveKeyBtn" onclick="saveApiKey()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded-lg text-xs font-bold transition">
                        Simpan
                    </button>
                </div>
                <div id="apiErrorMsg" class="hidden mt-2 text-[10px] text-red-400 font-bold">* API Key wajib diisi!</div>
            </div>

            <!-- Mode Toggle -->
            <div class="bg-slate-800 p-1 rounded-xl flex text-sm font-medium mb-2">
                <button onclick="setMode('clip')" id="mode-clip" class="flex-1 py-2.5 rounded-lg transition-all duration-300 active-mode">
                    Clip Tunggal<br><span class="text-[9px] font-normal opacity-70">(MovieFlow)</span>
                </button>
                <button onclick="setMode('series')" id="mode-series" class="flex-1 py-2.5 rounded-lg transition-all duration-300 inactive-mode">
                    Episodik<br><span class="text-[9px] font-normal opacity-70">(Veo Split)</span>
                </button>
            </div>
        </div>

        <!-- Form Content -->
        <div class="flex-1 overflow-y-auto no-scrollbar p-6 pt-2 space-y-6">

            <!-- Research & Random Tools -->
            <div class="grid grid-cols-2 gap-2">
                <button onclick="fillRandom()" class="px-3 py-2.5 rounded-xl bg-slate-800 text-slate-400 hover:text-white hover:bg-slate-700 text-xs font-bold flex flex-col items-center justify-center gap-1 transition border border-slate-700 group active:scale-95 h-16">
                    <i data-lucide="dice-5" class="w-5 h-5 group-hover:rotate-180 transition-transform duration-500 mb-1"></i> 
                    <span>Acak Manual</span>
                </button>
                <button onclick="researchTrendingTopic()" id="researchBtn" class="magic-btn px-3 py-2.5 rounded-xl text-white text-xs font-bold flex flex-col items-center justify-center gap-1 transition shadow-lg active:scale-95 hover:brightness-110 h-16">
                    <div class="flex items-center gap-2">
                        <i data-lucide="sparkles" class="w-4 h-4"></i> <span>Riset AI Variatif</span>
                    </div>
                    <span class="text-[9px] font-normal opacity-90 text-center leading-tight">Cari Tren Non-Horor</span>
                </button>
            </div>

            <!-- Niche Indicator -->
            <div id="nicheIndicator" class="hidden bg-indigo-900/30 border border-indigo-500/30 p-2 rounded-lg text-center animate-pulse">
                <p class="text-[10px] text-indigo-300">Sedang meriset kategori:</p>
                <p id="nicheText" class="text-xs font-bold text-white">...</p>
            </div>

            <!-- Duration -->
            <div class="space-y-2">
                <div class="flex justify-between items-center">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Durasi</label>
                    <span id="partIndicator" class="text-xs text-blue-400 bg-blue-500/10 px-2 py-0.5 rounded border border-blue-500/20">Full Single Clip</span>
                </div>
                <div id="duration-grid" class="grid grid-cols-3 gap-2">
                    <button onclick="setDuration(8)" id="dur-8" class="dur-btn py-2 bg-slate-800 border border-slate-700 rounded-lg text-xs hover:bg-slate-700 transition text-slate-400">8s</button>
                    <button onclick="setDuration(24)" id="dur-24" class="dur-btn py-2 bg-slate-800 border border-slate-700 rounded-lg text-xs hover:bg-slate-700 transition ring-1 ring-red-500 text-white bg-slate-700">24s</button>
                    <button onclick="setDuration(40)" id="dur-40" class="dur-btn py-2 bg-slate-800 border border-slate-700 rounded-lg text-xs hover:bg-slate-700 transition text-slate-400">40s</button>
                    <button onclick="setDuration(60)" id="dur-60" class="dur-btn py-2 bg-slate-800 border border-slate-700 rounded-lg text-xs hover:bg-slate-700 transition text-slate-400 font-bold text-blue-400">1 Menit</button>
                    <button onclick="setDuration(120)" id="dur-120" class="dur-btn py-2 bg-slate-800 border border-slate-700 rounded-lg text-xs hover:bg-slate-700 transition text-slate-400 font-bold text-purple-400 col-span-2">2 Menit</button>
                </div>
            </div>

            <!-- Style -->
            <div class="space-y-2">
                <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Style</label>
                <div class="grid grid-cols-2 gap-3">
                    <div onclick="selectStyle('Lego')" id="style-Lego" class="style-card cursor-pointer bg-slate-800 p-3 rounded-xl border border-slate-700 relative group ring-1 ring-blue-500 bg-slate-700">
                        <i data-lucide="box" class="w-5 h-5 text-yellow-500 mb-2"></i>
                        <span class="block text-xs font-medium">Lego</span>
                    </div>
                    <div onclick="selectStyle('Cinematic')" id="style-Cinematic" class="style-card cursor-pointer bg-slate-800 p-3 rounded-xl border border-slate-700 relative group hover:border-blue-500">
                        <i data-lucide="film" class="w-5 h-5 text-blue-500 mb-2"></i>
                        <span class="block text-xs font-medium">Realism</span>
                    </div>
                    <div onclick="selectStyle('Anime')" id="style-Anime" class="style-card cursor-pointer bg-slate-800 p-3 rounded-xl border border-slate-700 relative group hover:border-blue-500">
                        <i data-lucide="sparkles" class="w-5 h-5 text-pink-500 mb-2"></i>
                        <span class="block text-xs font-medium">Anime</span>
                    </div>
                    <div onclick="selectStyle('Claymation')" id="style-Claymation" class="style-card cursor-pointer bg-slate-800 p-3 rounded-xl border border-slate-700 relative group hover:border-blue-500">
                        <i data-lucide="smile" class="w-5 h-5 text-green-500 mb-2"></i>
                        <span class="block text-xs font-medium">Clay</span>
                    </div>
                </div>
            </div>

            <!-- Inputs -->
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Karakter</label>
                    <input type="text" id="charInput" placeholder="Contoh: Bajak laut tua..." class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm focus:border-blue-500 outline-none transition text-white placeholder-slate-500">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Ide Cerita</label>
                    <textarea id="ideaInput" rows="3" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm focus:border-blue-500 outline-none transition text-white placeholder-slate-500" placeholder="Jelaskan alur cerita..."></textarea>
                </div>
            </div>

            <!-- Status Logs -->
            <div id="statusLog" class="text-[10px] text-slate-500 font-mono text-center hidden">
                Status: Ready
            </div>

            <!-- Generate Button -->
            <button onclick="generateWithAI()" id="generateBtn" class="w-full bg-slate-800 hover:bg-slate-700 text-white font-bold py-4 rounded-xl shadow-lg border border-slate-700 transform hover:scale-[1.01] transition active:scale-95 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed disabled:grayscale">
                <i data-lucide="clapperboard" class="w-5 h-5 text-blue-400"></i>
                <span id="btnText">Buat Prompt Video</span>
            </button>

            <!-- Results -->
            <div id="resultsArea" class="hidden space-y-6 pt-2 pb-10">
                <div class="flex items-center gap-2 mb-2">
                    <div class="h-px bg-slate-700 flex-1"></div>
                    <span class="text-xs font-bold text-slate-500 uppercase">Hasil Generated</span>
                    <div class="h-px bg-slate-700 flex-1"></div>
                </div>
                
                <div id="tipBox" class="bg-emerald-900/20 border border-emerald-500/30 p-3 rounded-lg mb-4 text-[10px] text-emerald-200">
                    <i data-lucide="shield-check" class="w-3 h-3 inline mr-1"></i>
                    <span id="tipText"><b>Fitur Baru:</b> Prompt karakter otomatis diperluas (Full Body) untuk konsistensi maksimal.</span>
                </div>

                <div id="cardsContainer" class="space-y-4"></div>
            </div>

        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-4 py-3 rounded-xl shadow-2xl text-xs font-bold border border-slate-700 flex items-center gap-3 z-50 transition-all duration-300 toast-enter w-max max-w-[90%]">
        <div id="toastIcon" class="text-emerald-400">
            <i data-lucide="check-circle" class="w-5 h-5"></i>
        </div>
        <span id="toastMsg">Berhasil disalin!</span>
    </div>

    <script>
        // Init
        window.addEventListener('load', () => {
            if (typeof lucide !== 'undefined') lucide.createIcons();
            const savedKey = localStorage.getItem('groq_api_key');
            if (savedKey) {
                state.apiKey = savedKey;
                state.isKeyLocked = true;
                const input = document.getElementById('apiKeyInput');
                const btn = document.getElementById('saveKeyBtn');
                const triggerBtn = document.getElementById('apiKeyTriggerBtn');
                input.value = savedKey; 
                input.disabled = true;
                btn.innerHTML = "Terkunci";
                btn.classList.add('bg-emerald-600');
                triggerBtn.classList.add('text-emerald-400', 'border-emerald-500/30');
            }
        });

        let state = {
            mode: 'clip', 
            duration: 24, 
            style: 'Lego',
            apiKey: '',
            isKeyLocked: false
        };

        const SCENE_DURATION_SPLIT = 8;
        
        // --- DATA RANDOM OFFLINE (Beragam) ---
        const randomData = [
            { char: "Astronot Kucing Oyen, jaket silver, sepatu bot neon", idea: "Mendarat di Mars tapi ternyata isinya cuma warung pecel lele alien.", style: "Claymation" },
            { char: "Pembalap Bajaj, helm full face, jaket kulit lusuh", idea: "Balapan liar di sirkuit Jakarta tahun 2077 dengan bajaj terbang.", style: "Anime" },
            { char: "Detektif Bebek, jas hujan kuning, topi fedora", idea: "Menyelidiki siapa yang mencuri busa sabun di kamar mandi raksasa.", style: "Lego" },
            { char: "Robot Barista, apron denim, badan stainless steel", idea: "Kewalahan melayani ribuan pelanggan zombie.", style: "Cinematic" },
            { char: "Dinosaurus T-Rex, topi koki putih, celemek merah", idea: "Mencoba memasak nasi goreng tapi tangannya terlalu pendek.", style: "Claymation" },
            { char: "Ninja Gojek, jaket hijau hitam, pedang di punggung", idea: "Mengantar paket rahasia melompati gedung-gedung tinggi.", style: "Anime" },
        ];

        // --- KATEGORI TREN ---
        const trendingNiches = [
            "Komedi 'Relate' Kantor/Sekolah",
            "Review Makanan Pinggir Jalan",
            "Teknologi Masa Depan Jakarta 2050",
            "Kehidupan Kucing Lucu",
            "Edukasi Sejarah Unik Indonesia",
            "Olahraga Ekstrem (Parkour/Silat)",
            "Fashion Show Jalanan",
            "DIY Kerajinan Barang Bekas",
            "Petualangan Alam/Gunung",
            "Superherol Lokal"
        ];

        function updateStatus(msg) {
            const el = document.getElementById('statusLog');
            el.classList.remove('hidden');
            el.innerText = msg;
        }

        // --- AI Research Function ---
        async function researchTrendingTopic() {
            if (!state.apiKey) { toggleApiSection(); showToast("Isi API Key dulu untuk Riset AI!", "error"); return; }
            
            const btn = document.getElementById('researchBtn');
            const originalHTML = btn.innerHTML;
            const nicheBox = document.getElementById('nicheIndicator');
            const nicheText = document.getElementById('nicheText');
            
            const selectedNiche = trendingNiches[Math.floor(Math.random() * trendingNiches.length)];
            
            nicheBox.classList.remove('hidden');
            nicheText.innerText = selectedNiche;

            try {
                btn.disabled = true;
                btn.innerHTML = `<div class="loader w-4 h-4 border-2"></div>`;
                updateStatus(`AI sedang meriset: ${selectedNiche}...`);

                const researchPrompt = `
                    Bertindaklah sebagai Content Creator Kreatif.
                    Kategori: "${selectedNiche}".
                    
                    Output JSON Murni:
                    {
                        "character": "Deskripsi visual karakter (singkat saja, nanti akan didetailkan)",
                        "idea": "Alur cerita singkat (1 kalimat)",
                        "style": "Pilih satu: 'Lego', 'Cinematic', 'Anime', 'Claymation'"
                    }
                `;

                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${state.apiKey}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        messages: [{ role: "user", content: researchPrompt }],
                        model: "llama-3.3-70b-versatile",
                        temperature: 0.9 
                    })
                });

                if (!response.ok) throw new Error("Gagal menghubungi AI");
                const data = await response.json();
                const content = data.choices[0].message.content;
                
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error("Format AI Error");
                
                const result = JSON.parse(jsonMatch[0]);

                document.getElementById('charInput').value = result.character;
                document.getElementById('ideaInput').value = result.idea;
                
                let targetStyle = "Cinematic";
                if (result.style.toLowerCase().includes("lego")) targetStyle = "Lego";
                else if (result.style.toLowerCase().includes("anime")) targetStyle = "Anime";
                else if (result.style.toLowerCase().includes("clay")) targetStyle = "Claymation";
                
                selectStyle(targetStyle);

                showToast(`Ide: ${selectedNiche} Siap!`, "success");
                updateStatus(`Selesai. Kategori: ${selectedNiche}`);

            } catch (error) {
                console.error(error);
                showToast("Riset Gagal: " + error.message, "error");
                updateStatus("Gagal Riset.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
                nicheBox.classList.add('hidden');
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
        }

        function fillRandom() {
            const rand = randomData[Math.floor(Math.random() * randomData.length)];
            document.getElementById('charInput').value = rand.char;
            document.getElementById('ideaInput').value = rand.idea;
            selectStyle(rand.style);
            showToast("Ide Acak Diterapkan!", "success");
        }

        function toggleApiSection() {
            const el = document.getElementById('apiSection');
            el.classList.toggle('hidden');
        }

        function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            const btn = document.getElementById('saveKeyBtn');
            const val = input.value.trim();
            if (!val) { showToast("Isi API Key!", "error"); return; }
            state.apiKey = val;
            state.isKeyLocked = true;
            localStorage.setItem('groq_api_key', val);
            input.disabled = true;
            input.type = "password";
            btn.innerHTML = "Terkunci";
            btn.classList.add('bg-emerald-600');
            toggleApiSection(); 
            showToast("API Key tersimpan.");
        }

        function setMode(mode) {
            state.mode = mode;
            const btnClip = document.getElementById('mode-clip');
            const btnSeries = document.getElementById('mode-series');
            if (mode === 'clip') {
                btnClip.classList.add('active-mode'); btnClip.classList.remove('inactive-mode');
                btnSeries.classList.remove('active-mode'); btnSeries.classList.add('inactive-mode');
            } else {
                btnSeries.classList.add('active-mode'); btnSeries.classList.remove('inactive-mode');
                btnClip.classList.remove('active-mode'); btnClip.classList.add('inactive-mode');
            }
            updatePartIndicator();
        }

        function setDuration(dur) {
            state.duration = dur;
            updatePartIndicator();
            document.querySelectorAll('.dur-btn').forEach(btn => {
                btn.classList.remove('ring-1', 'ring-red-500', 'text-white', 'bg-slate-700');
                btn.classList.add('text-slate-400');
                if(btn.id === 'dur-60') btn.classList.add('text-blue-400');
                if(btn.id === 'dur-120') btn.classList.add('text-purple-400');
            });
            const active = document.getElementById(`dur-${dur}`);
            if (active) {
                active.classList.add('ring-1', 'ring-red-500', 'text-white', 'bg-slate-700');
                active.classList.remove('text-slate-400', 'text-blue-400', 'text-purple-400');
            }
        }

        function updatePartIndicator() {
            const el = document.getElementById('partIndicator');
            if (state.mode === 'clip') {
                el.innerText = "Full Single Clip (MovieFlow)";
            } else {
                const parts = Math.ceil(state.duration / SCENE_DURATION_SPLIT);
                el.innerText = `${parts} Parts (Veo Split)`;
            }
        }

        function selectStyle(styleName) {
            state.style = styleName;
            document.querySelectorAll('.style-card').forEach(card => {
                card.classList.remove('ring-1', 'ring-blue-500', 'bg-slate-700');
            });
            const active = document.getElementById(`style-${styleName}`);
            if (active) active.classList.add('ring-1', 'ring-blue-500', 'bg-slate-700');
        }

        async function generateWithAI() {
            if (!state.apiKey) { toggleApiSection(); showToast("Isi API Key!", "error"); return; }
            const char = document.getElementById('charInput').value;
            const idea = document.getElementById('ideaInput').value;
            if (!char || !idea) { showToast("Data belum lengkap!", "error"); return; }

            const btn = document.getElementById('generateBtn');
            const btnTextEl = document.getElementById('btnText');
            const originalText = btnTextEl.innerText;
            btn.disabled = true;
            btnTextEl.innerHTML = "Processing...";
            const iconEl = btn.querySelector('svg');
            if(iconEl) iconEl.remove();
            btn.insertAdjacentHTML('afterbegin', '<div class="loader mr-2"></div>');
            
            updateStatus("Memperjelas Karakter & Adegan...");

            let systemPrompt = "";
            let userPrompt = "";

            // --- PERUBAHAN PENTING DI SINI: MEMAKSA DESKRIPSI FULL BODY ---
            if (state.mode === 'clip') {
                systemPrompt = `You are a video prompt expert.
                
                CRITICAL INSTRUCTION:
                You MUST create a 'character_desc' field that describes the character's FULL BODY appearance (Head to Toe) to ensure video consistency.
                Include: Specific clothing (shirt color, pants type), footwear, accessories, body type, and age.
                
                Create ONE JSON object. Style: ${state.style}.
                JSON format strictly: 
                [{"character_desc": "Detailed Head-to-Toe Description...", "prompt": "Timeline (00-10s)...(10-${state.duration}s)", "camera": "Detailed camera movement", "audio": "Sound design"}]`;
                
                userPrompt = `Character Concept: ${char}. Story: ${idea}. Duration: ${state.duration}s. Single continuous shot.`;
            } else {
                const totalParts = Math.ceil(state.duration / SCENE_DURATION_SPLIT);
                systemPrompt = `You are a video prompt expert.
                
                CRITICAL INSTRUCTION:
                The 'character_desc' MUST be IDENTICAL in all parts to keep the character consistent.
                Describe FULL BODY (Head to Toe): Clothing, Colors, Accessories.

                Create ${totalParts} JSON objects. Style: ${state.style}.
                JSON format strictly: 
                [{"part": 1, "character_desc": "Detailed Head-to-Toe Description...", "prompt": "Action...", "camera": "...", "audio": "..."}]`;
                
                userPrompt = `Character Concept: ${char}. Story: ${idea}. Duration: ${state.duration}s. Split into parts.`;
            }

            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${state.apiKey}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        messages: [{ role: "system", content: systemPrompt }, { role: "user", content: userPrompt }],
                        model: "llama-3.3-70b-versatile",
                        temperature: 0.6
                    })
                });

                if (!response.ok) throw new Error("API Key Error / Koneksi");
                const data = await response.json();
                const aiContent = data.choices[0].message.content;
                const jsonMatch = aiContent.match(/\[[\s\S]*\]/) || aiContent.match(/\{[\s\S]*\}/);
                
                if (!jsonMatch) throw new Error("Format JSON Salah dari AI");
                let parsedScenes = JSON.parse(jsonMatch[0]);

                if (!Array.isArray(parsedScenes)) parsedScenes = [parsedScenes];

                // Merge Logic untuk Single Clip
                if (state.mode === 'clip' && parsedScenes.length > 1) {
                    let mergedPrompt = parsedScenes.map(p => p.prompt || p.scene_description).join(" ");
                    let mergedCamera = parsedScenes[0].camera || "Dynamic tracking shot";
                    let mergedAudio = parsedScenes[0].audio || "Immersive ambient";
                    let mergedChar = parsedScenes[0].character_desc || char; // Ambil deskripsi karakter
                    
                    parsedScenes = [{
                        character_desc: mergedChar,
                        prompt: mergedPrompt,
                        camera: mergedCamera,
                        audio: mergedAudio
                    }];
                }

                renderCards(parsedScenes);
                showToast("Berhasil Generate dengan Konsistensi Full Body!", "success");
                updateStatus("Selesai.");

            } catch (error) {
                console.error(error);
                showToast("Error: " + error.message, "error");
                updateStatus("Gagal: " + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = ''; 
                btn.insertAdjacentHTML('afterbegin', `<i data-lucide="clapperboard" class="w-5 h-5 text-blue-400"></i>`);
                btn.insertAdjacentHTML('beforeend', `<span id="btnText" class="ml-2">${originalText}</span>`);
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
        }

        function renderCards(scenesArray) {
            const container = document.getElementById('cardsContainer');
            const tipText = document.getElementById('tipText');
            container.innerHTML = ''; 
            document.getElementById('resultsArea').classList.remove('hidden');

            if (state.mode === 'clip') {
                tipText.innerHTML = "<b>Mode Clip Tunggal:</b> Prompt karakter di bawah sudah didetailkan (Full Body) untuk konsistensi.";
            } else {
                tipText.innerHTML = "<b>Mode Episodik:</b> Deskripsi karakter disamakan tiap part agar tidak berubah bentuk.";
            }

            scenesArray.forEach((scene, index) => {
                // PRIORITAS: Pakai deskripsi detail dari AI, kalau gagal baru pakai input user
                const finalCharDesc = scene.character_desc || scene.character_description || document.getElementById('charInput').value;

                const outputObject = {
                    "character_consistency": finalCharDesc,
                    "style": state.style,
                    "timeline_action": scene.prompt || scene.scene_description || "No description generated",
                    "camera": scene.camera || scene.camera_movement || "Static",
                    "audio": scene.audio || scene.audio_prompt || "Ambient sound",
                    "duration_setting": state.mode === 'clip' ? `${state.duration}s` : "8s"
                };
                
                const jsonString = JSON.stringify(outputObject, null, 2);
                let headerTitle = state.mode === 'clip' ? "FULL CONTINUOUS CLIP" : `PART ${index + 1}`;
                let timeLabel = state.mode === 'clip' ? `00:00 - ${state.duration}s` : `00:${(index * 8).toString().padStart(2, '0')} - 00:${((index + 1) * 8).toString().padStart(2, '0')}`;
                
                const cardHtml = `
                    <div class="glass-panel rounded-xl overflow-hidden border border-slate-700 animate-[fadeIn_0.5s_ease-out]">
                        <div class="bg-slate-800/50 px-4 py-3 flex justify-between items-center border-b border-slate-700">
                            <div class="flex items-center gap-2">
                                <span class="bg-indigo-600 text-white text-[10px] font-bold px-2 py-1 rounded tracking-wider">${headerTitle}</span>
                                <span class="text-xs text-slate-400">${timeLabel}</span>
                            </div>
                            <button onclick="copyCard(this)" class="text-xs flex items-center gap-1 text-blue-400 hover:text-blue-300 transition">
                                <i data-lucide="copy" class="w-3 h-3"></i> Salin
                            </button>
                        </div>
                        <div class="p-0 bg-black/40 relative group">
                            <textarea class="hidden copy-source">${jsonString}</textarea>
                            <pre class="text-[10px] font-mono text-green-400 p-4 overflow-x-auto custom-scrollbar json-content select-text">${jsonString}</pre>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', cardHtml);
            });
            if (typeof lucide !== 'undefined') lucide.createIcons();
            document.getElementById('resultsArea').scrollIntoView({ behavior: 'smooth' });
        }

        function copyCard(btnElement) {
            const cardBody = btnElement.closest('.glass-panel');
            const jsonText = cardBody.querySelector('.copy-source').value;

            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(jsonText)
                    .then(() => showToast("JSON berhasil disalin!", "success"))
                    .catch(() => fallbackCopy(jsonText));
            } else {
                fallbackCopy(jsonText);
            }
        }

        function fallbackCopy(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showToast("JSON berhasil disalin!", "success");
            } catch (err) {
                showToast("Gagal menyalin manual", "error");
            }
            
            document.body.removeChild(textArea);
        }

        function showToast(msg, type = "success") {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toastMsg');
            const iconEl = document.getElementById('toastIcon');
            msgEl.innerText = msg;
            
            if (type === 'error') {
                toast.classList.remove('border-slate-700'); toast.classList.add('border-red-500', 'bg-red-900/90');
                iconEl.innerHTML = `<i data-lucide="alert-circle" class="w-5 h-5 text-white"></i>`;
            } else {
                toast.classList.remove('border-red-500', 'bg-red-900/90'); toast.classList.add('border-slate-700', 'bg-slate-800');
                iconEl.innerHTML = `<i data-lucide="check-circle" class="w-5 h-5 text-emerald-400"></i>`;
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
            toast.classList.remove('toast-enter'); toast.classList.add('toast-active');
            setTimeout(() => { toast.classList.remove('toast-active'); toast.classList.add('toast-enter'); }, 3000);
        }
    </script>
</body>
</html>


